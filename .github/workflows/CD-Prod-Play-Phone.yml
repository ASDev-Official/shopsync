name: CD-Prod-Play-Phone

on:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  cd-build-and-upload:
    name: CD-Build and Upload Phone to Google Play Production
    environment: google-play-deployment
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.3'
          cache: true

      - name: Cache Pub packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache/hosted
            ~/.pub-cache/git
            ${{ github.workspace }}/.dart_tool
          key: pub-cache-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            pub-cache-${{ runner.os }}-

      - name: Cache Android build outputs
        uses: actions/cache@v4
        with:
          path: |
            android/.gradle
            android/app/build
            build/
            .dart_tool/flutter_build
          key: android-phone-${{ runner.os }}-${{ hashFiles('**/pubspec.lock', '**/build.gradle', '**/gradle.properties') }}
          restore-keys: |
            android-phone-${{ runner.os }}-

      - name: Decode Keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > app/release-key.jks
        working-directory: android

      - name: Create key.properties
        run: |
          echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" > key.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> key.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> key.properties
          echo "storeFile=release-key.jks" >> key.properties
        working-directory: android

      - name: Create sentry.properties
        run: |
          echo "${{ secrets.SENTRY_PROPERTIES }}" >> sentry.properties

      - name: Get dependencies
        run: flutter pub get

      - name: Build AAB for Phone
        run: flutter build appbundle --release --flavor phone --target=lib/main.dart

      - name: Upload to Google Play
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.SERVICE_ACCOUNT_JSON }}
          packageName: com.aadishsamir.shopsync
          releaseFiles: build/app/outputs/bundle/phoneRelease/app-phone-release.aab
          track: production
          whatsNewDirectory: distribution/whatsnew-play

      - name: Build Completion Summary
        if: success()
        run: |
          echo "## Phone Release Build" >> $GITHUB_STEP_SUMMARY
          echo "✅ Phone App Bundle built and uploaded to Google Play (Production)" >> $GITHUB_STEP_SUMMARY
          echo "- Flavor: phone" >> $GITHUB_STEP_SUMMARY
          echo "- Target: lib/main.dart" >> $GITHUB_STEP_SUMMARY

      - name: Build Failure Summary
        if: failure()
        run: |
          echo "## Phone Release Build" >> $GITHUB_STEP_SUMMARY
          echo "❌ Phone build or upload failed" >> $GITHUB_STEP_SUMMARY
          echo "Check logs above for details" >> $GITHUB_STEP_SUMMARY
